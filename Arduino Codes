#include <Wire.h>
#include <Adafruit_SSD1306.h>

Adafruit_SSD1306 display(128, 64, &Wire, -1);


#define BUTTON_PIN 3

// Threshold of the datas
const int   HR_HIGH_BPM = 90;
const float BT_HIGH_C   = 36.9;

// Chaneg in 3s
const unsigned long HOLD_MS = 3000;

// total calm duration is 1 min
const unsigned long CALM_TOTAL_MS = 60UL * 1000UL;

// The breathing pattern is like 4 in 6 out, I've already put it into the refernece page as we can write the rationale and reports. 
const unsigned long IN_MS = 4000;
const unsigned long OUT_MS = 6000;
const unsigned long CYCLE_MS = IN_MS + OUT_MS;

// Frame rate 
const unsigned long FRAME_MS = 80;
unsigned long lastFrame = 0;

//Change here, This is the estimate values, repalce with the sensors' values. 
int currBpm = 72;
float currTempC = 36.5;

// Mode of the system
bool calmMode = false;
bool bothHigh = false;
unsigned long bothHighSince = 0;
unsigned long calmStart = 0;

bool forceHigh = false;
bool buttonPressed = false;

// here is the thershold setting, I set it with 98 and 37.1. 
bool isBothHigh(int bpm, float tC) {
  return (bpm >= HR_HIGH_BPM) && (tC >= BT_HIGH_C);
}

void drawBreathBar(float pct) {
  pct = constrain(pct, 0.0, 1.0);
  int x = 8, y = 50, w = 112, h = 10;
  display.drawRect(x, y, w, h, SSD1306_WHITE);
  int fillW = (int)((w - 2) * pct);
  display.fillRect(x + 1, y + 1, fillW, h - 2, SSD1306_WHITE);
}

void showNormalScreen(bool highState) {
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  display.setTextSize(1);
  display.setCursor(0, 0);
  display.print("Sleep Calm Demo");

  display.setCursor(0, 14);
  display.print("HR: ");
  display.print(currBpm);
  display.print(" bpm");

  display.setCursor(0, 26);
  display.print("BT: ");
  display.print(currTempC, 1);
  display.print(" C");

  display.setCursor(0, 40);
  display.print("Status: ");
  display.print(highState ? "HIGH arousal" : "OK");

  display.setCursor(0, 55);
  display.print("Press btn=toggle high");

  display.display();
}

void showCalmScreen() {
  unsigned long t = millis() - calmStart;

  if (t >= CALM_TOTAL_MS) {
    calmMode = false;
    return;
  }

  unsigned long m = t % CYCLE_MS;
  const char* phase;
  float barPct;

  if (m < IN_MS) {
    phase = "BREATHE IN";
    barPct = (float)m / (float)IN_MS;
  } else {
    phase = "BREATHE OUT";
    unsigned long x = m - IN_MS;
    barPct = 1.0 - (float)x / (float)OUT_MS;
  }

  unsigned long leftS = (CALM_TOTAL_MS - t) / 1000;

  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  display.setTextSize(1);
  display.setCursor(0, 0);
  display.print("1 min calming guide");

  display.setCursor(0, 12);
  display.print("HR:");
  display.print(currBpm);
  display.print("  BT:");
  display.print(currTempC, 1);

  display.setTextSize(1);
  display.setCursor(0, 26);
  display.print(phase);

  display.setTextSize(1);
  drawBreathBar(barPct);

  display.setCursor(0, 40);
  display.print("4 IN / 6 OUT (10s)");

  display.setCursor(80, 26);
  display.print(leftS);
  display.print("s");

  display.display();
}

void updateSimulatedSensors() {
  // If forced high, jump to high-ish values; else drift around normal
  if (forceHigh) {
    currBpm = 98;
    currTempC = 37.1;
  } else {
    // small drift so screen doesn't look frozen
    static int dir = 1;
    currBpm += dir;
    if (currBpm > 78) dir = -1;
    if (currBpm < 70) dir = 1;

    static float tdir = 0.02;
    currTempC += tdir;
    if (currTempC > 36.7) tdir = -0.02;
    if (currTempC < 36.4) tdir = 0.02;
  }
}

void handleButton() {
  int s = digitalRead(BUTTON_PIN);

  // like your Dino game: detect press-release
  if (s == HIGH && !buttonPressed) buttonPressed = true;
  if (s == LOW && buttonPressed) {
    buttonPressed = false;
    forceHigh = !forceHigh; // toggle
  }
}

void setup() {
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    while (1);
  }
  display.clearDisplay();
  display.display();
}

void loop() {
  unsigned long now = millis();
  if (now - lastFrame < FRAME_MS) return;
  lastFrame = now;

  handleButton();
  updateSimulatedSensors();

  // Trigger logic (if not already calm)
  if (!calmMode) {
    bool highNow = isBothHigh(currBpm, currTempC);

    if (highNow) {
      if (!bothHigh) {
        bothHigh = true;
        bothHighSince = now;
      }
    } else {
      bothHigh = false;
      bothHighSince = 0;
    }

    if (bothHigh && (now - bothHighSince >= HOLD_MS)) {
      calmMode = true;
      calmStart = now;
    }

    showNormalScreen(highNow);
  } else {
    showCalmScreen();
  }
}
